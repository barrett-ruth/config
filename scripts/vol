#!/bin/sh

[ "$1" ] || exit

cmd="$1"
shift
sink="$(pacmd list-sinks | rg '\* index: ' | tail -c 2)"
filler_icon='/usr/share/icons/Adwaita/16x16/status/airplane-mode-symbolic.symbolic.png'

format_chars() {
    in="$1"

    [ "$in" -gt 100 ] && in=100
    [ "$in" -eq 0 ] || fill="$(printf "%$((in / 5))"s | sed 's| |-|g')"

    rest="$(printf "%$((20 - in / 5))"s)"

    echo "$fill$rest"
}

final_bar() {
    vol="$(pactl get-sink-volume "$sink" | awk '{ print $5 }')"
    vol="${vol%?}"
    spacing='  '
    bar="$(format_chars "$vol")$spacing"

    [ "${#vol}" -eq 1 ] && bar="$bar "
    [ "${#vol}" -eq 2 ] && bar="$bar "

    [ "${#vol}" -eq 3 ] && mutepad=' '
    [ "$(pactl get-sink-mute "$sink" | awk '{ print $2 }')" = 'yes' ] && unset vol

    [ "$vol" ] && vol="$vol"V || vol=$mutepad'n/a'

    echo " $bar$vol"
}

case "$cmd" in
up | down)
    [ "$cmd" = up ] && change=+ || change=-
    pactl set-sink-volume "$sink" "$change${1:-5}%"
    ;;
mute)
    pactl set-sink-mute "$sink" toggle
    ;;
toggle)
    [ "$sink" = 4 ] && target=2_
    state="$(pacmd list-sinks | rg 'state: ')"
    [ "${state##*RUNNING*}" ] && sus=0 || sus=1
    pacmd suspend-sink alsa_output.pci-0000_00_1f.3-platform-sof_sdw.HiFi__hw_sofsoundwire_"$target"_sink "$sus"
    ;;
esac

dunstify -r 1 -i "$filler_icon" "$(final_bar)"
